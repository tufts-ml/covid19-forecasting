# ABC MCMC to estimate parameters of hospital model
Gian Marco Visani - 02/10/2021

Implements ABC MCMC as described in as described in https://arxiv.org/pdf/1001.2058.pdf, with some variations.

## Setup

Requirements:
    - A json file containing the prior over each set of parameters
    - A json file containing the config information necessary for the hospital model to run a simulation. This includes:
        - Initial (currently not warmed-up) counts at each state of the hospital
        - Number of timesteps to simulate (training + testing)
        - A source to draw admissions from, currently a pointer to a file containing admissions per timestep
        - A csv file containing admissions per timestep. These admissions an be at any state of the hospital
    - A csv file containing the true hospital census counts for training (can include testing counts as well, they get filtered out anyways)

## Step 1: Run ABC

Run the following command:
    `python sampling_slow_code_clean.py`
    OR (for faster code)
    `python sampling_fast_code_clean.py`

See the default arguments and their explanation for the arguments in each file.

Output:
    - Samples file (json), containing the last samples of parameters (currently the last 1/2 of samples) as a list of dictionaries
    - Stats file (csv) containing a history of all relevant statistics at each step of the sampling procedure (epsilon trace, accepted distances, all distances, accepted alphas, all alphas)
    - The last 1000 forecasts on testing (in a single, easy to parse csv file), each generated by the last 1000 sampled sets of parameters. These forecasts are generated together with the training data, and thus they are'warmed-up', i.e. the patients present in the hospital at day zero of testing are assumed to have been there for some realistic nnumber of days already

## Step 2: unpack warmed-up forecasts on testing into individual csv files

Run the following command:
    `python collect_warmed_up_forecasts.py --concat_file [results/abc_MA_last_forecasts.csv] --num_samples 100 --output_file [results_MA_index=0.csv]`

Note: must include '\_index=0' at the end of your desired filename to allow the scripts to generate and then identify the individual forecasts.

This step is only performed to make the input compatible with files summarize_forecasts.py and ABC_test_metrics.py. Alternatively, those two files can be changed to take as input the unpacked forecasts.

## Step 3: compute summaries of forecasts

Run the following command:
    `python summarize_forecasts.py --input_dir [output] --output_dir [output] --output_template [summary_MA_]
                                   --input_csv_file_pattern [results_MA_*.csv] --comma_sep_percentiles [1,2.5,5,10,25,50,75,90,95,97.5,99]
                                   --include_los [False]`

- *input_csv_file_pattern* identifies all the files containing the forecasts from the script collect_warmed_up_forecasts.py.
- *include_los* says whether we want to compute summaries for the los results as well.

The summaries include (one file for each one): mean, stddev, and all percentiles specified by *comma_sep_percentiles*

## Step 4: compute relevant metrics

Run the following command:
    `python ABC_test_metrics.py --input_dir [output] --output_dir [results] --output_template [metrics]
                                --true_stats [configs/MA.csv] --input_simulations_pattern results_MA_*.csv
                                --input_summaries_template [summary_MA_] --coverages 2.5_97.5,10_90,25_75
                                --comma_sep_expected_columns n_InGeneralWard,n_OffVentInICU,n_OnVentInICU`

The script currently computes:
    - Empirical pmf for each expected_column, per timestep.
    - MAE for each expected_column, averaged over timesteps.
    - Coverage for each expected_column. Coverages are user-specified in the following format: low1_high1,low2_high2,...,lowN_highN.

- *input_simulations_pattern* identifies all the files containing the forecasts from the script collect_warmed_up_forecasts.py.
- *input_summaries_template* identifies the files containing summaries of the forecasts, i.e. the files generated by the script summarize_forecasts.py.